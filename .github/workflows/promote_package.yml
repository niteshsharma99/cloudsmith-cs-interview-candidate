name: Promote Python Package

on:
  repository_dispatch:
    types: [cloudsmith-package-sync]

#Third change staging/production repo names swapped
env:
  CLOUDSMITH_NAMESPACE: ${{ vars.CLOUDSMITH_NAMESPACE }}
  CLOUDSMITH_STAGING_REPO: "staging"
  CLOUDSMITH_PRODUCTION_REPO: "production"
  CLOUDSMITH_SERVICE_SLUG: ${{ vars.CLOUDSMITH_SERVICE_SLUG }}

permissions:
  id-token: write

jobs:
  tag-and-promote:
    runs-on: ubuntu-latest
    steps:
      - name: Install Cloudsmith CLI
        uses: cloudsmith-io/cloudsmith-cli-action@v1.0.1
        with:
          oidc-namespace: ${{ env.CLOUDSMITH_NAMESPACE }}
          oidc-service-slug: ${{ env.CLOUDSMITH_SERVICE_SLUG }}
      #change 4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug webhook payload
        run: |
          echo "=== Webhook Payload Received ==="
          echo '${{ toJson(github.event.client_payload) }}'
          echo "================================"

      - name: Get latest synced package and tag it
        run: |
          echo "Fetching latest package from staging repository..."

          # Get the most recently uploaded package
          LATEST_PACKAGE=$(cloudsmith list package ${{ env.CLOUDSMITH_NAMESPACE }}/${{ env.CLOUDSMITH_STAGING_REPO }} -F json | jq -r '.data[0]')

          if [ -z "$LATEST_PACKAGE" ] || [ "$LATEST_PACKAGE" = "null" ]; then
            echo "ERROR: No packages found in staging repository"
            exit 1
          fi

          IDENTIFIER=$(echo "$LATEST_PACKAGE" | jq -r '.identifier_perm')
          NAME=$(echo "$LATEST_PACKAGE" | jq -r '.name')
          VERSION=$(echo "$LATEST_PACKAGE" | jq -r '.version')

          echo "Latest package: $NAME version $VERSION (identifier: $IDENTIFIER)"

          if [ -z "$IDENTIFIER" ] || [ "$IDENTIFIER" = "null" ]; then
            echo "ERROR: Invalid package identifier"
            exit 1
          fi

          echo "Tagging package with 'ready-for-production'"
          cloudsmith tags add \
            ${{ env.CLOUDSMITH_NAMESPACE }}/${{ env.CLOUDSMITH_STAGING_REPO }}/$IDENTIFIER \
            ready-for-production

          echo "Package successfully tagged"
        shell: bash

      - name: Promote all ready-for-production packages to production
        run: |
          PACKAGE_QUERY="tag:ready-for-production"
          echo "Searching for packages with query: $PACKAGE_QUERY"

          PACKAGE_DATA=$(cloudsmith list package ${{ env.CLOUDSMITH_NAMESPACE }}/${{ env.CLOUDSMITH_STAGING_REPO }} -q "$PACKAGE_QUERY" -F json)

          # Check if any packages were found
          PACKAGE_COUNT=$(echo "$PACKAGE_DATA" | jq -r '.data | length')
          if [ "$PACKAGE_COUNT" -eq 0 ]; then
            echo "No packages found with ready-for-production tag"
            exit 1
          fi

          echo "Found $PACKAGE_COUNT package(s) with ready-for-production tag"

          # Iterate through all packages and promote them
          echo "$PACKAGE_DATA" | jq -c '.data[]' | while read -r package; do
            IDENTIFIER=$(echo "$package" | jq -r '.identifier_perm')
            NAME=$(echo "$package" | jq -r '.name')
            VERSION=$(echo "$package" | jq -r '.version')
            
            if [ -z "$IDENTIFIER" ] || [ "$IDENTIFIER" = "null" ]; then
              echo "Skipping package with invalid identifier"
              continue
            fi
            
            echo "Promoting package: $NAME version $VERSION (identifier: $IDENTIFIER)"
            
            # Promote package using the identifier
            cloudsmith mv --yes \
              ${{ env.CLOUDSMITH_NAMESPACE }}/${{ env.CLOUDSMITH_STAGING_REPO }}/$IDENTIFIER \
              ${{ env.CLOUDSMITH_PRODUCTION_REPO }}
            
            if [ $? -eq 0 ]; then
              echo "Successfully promoted $NAME version $VERSION to production"
            else
              echo "Failed to promote $NAME version $VERSION"
              exit 1
            fi
          done

          echo "All packages promoted successfully"
        shell: bash
